import yfinance as yf
import pandas as pd
import numpy as np
import statsmodels.api as sm

# definir as datas de início e fim
start_date = '2022-01-01'
end_date = '2022-03-13'

# baixar os preços de fechamento
tickers = ['PETR4.SA', 'ABEV3.SA', 'VALE3.SA', 'ITUB4.SA', 'B3SA3.SA']
df = yf.download(tickers, start=start_date, end=end_date)['Adj Close']

# baixar o ^BVSP
df['^BVSP'] = yf.download('^BVSP', start=start_date, end=end_date)['Adj Close']

# calcular os retornos diários
retornos = df.pct_change().dropna()

# calcular os betas
X = sm.add_constant(retornos['^BVSP'])
betas = pd.DataFrame(index=retornos.columns, columns=['Beta'])
for ticker in retornos.columns:
    y = retornos[ticker]
    model = sm.OLS(y, X, missing='drop')
    results = model.fit()
    betas.loc[ticker] = results.params['^BVSP']
    
print(betas)
